"use strict";(self["webpackChunkclient"]=self["webpackChunkclient"]||[]).push([[8015,6361],{8015:function(e,a,t){t.r(a),t.d(a,{save:function(){return k},saveAll:function(){return $},saveAs:function(){return V}});var r=t(7753),n=t(70375),l=t(13802),s=t(61681),i=t(78668),o=t(50516),u=t(60691),y=t(66361),c=t(20692),d=t(54957),f=t(81577),p=t(486),m=t(84513),w=t(31370);const h=l.Z.getLogger("esri.layers.FeatureLayer"),b="Feature Service";function S(e,a){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${a}`}function I(e,a){if(a.type!==b)throw new n.Z("feature-layer:portal-item-wrong-type",S(e,`should have portal item of type "${b}"`))}async function v(e){if(await e.load(),(0,d.rQ)(e))throw new n.Z("feature-layer:save",S(e,"using an in-memory source cannot be saved to a portal item"))}function L(e,a){let t=e.messages.filter((({type:e})=>"error"===e)).map((({name:e,message:a,details:t})=>new n.Z(e,a,t)));if(a?.ignoreUnsupported&&(t=t.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),t.length>0)throw new n.Z("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:t})}async function P(e,a,t){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},a);return L(a,t),r}function g(e){const{layer:a,layerJSON:t}=e;return a.isTable?{layers:[],tables:[t]}:{layers:[t],tables:[]}}function O(e){(0,w.qj)(e,w.Kz.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,a,t)=>t.indexOf(e)===a)))}function T(e){const a=e.portalItem;if(!a)throw h.error("save: requires the portalItem property to be set"),new n.Z("feature-layer:portal-item-not-set",S(e,"requires the portalItem property to be set"));if(!a.loaded)throw new n.Z("feature-layer:portal-item-not-loaded",S(e,"cannot be saved to a portal item that does not exist or is inaccessible"));I(e,a)}async function N(e,a){return/\/\d+\/?$/.test(e.url)?g(a[0]):C(e,a)}async function C(e,a){const{layer:{url:t,customParameters:r,apiKey:n}}=a[0];let l=await e.fetchData("json");l&&null!=l.layers&&null!=l.tables||(l=await F(l,{url:t,customParameters:r,apiKey:n},a.map((e=>e.layer.layerId))));for(const s of a)Z(s.layer,s.layerJSON,l);return l}async function F(e,a,t){var r,n;e||(e={}),(r=e).layers||(r.layers=[]),(n=e).tables||(n.tables=[]);const{url:l,customParameters:s,apiKey:i}=a,{serviceJSON:o,layersJSON:u}=await(0,y.fetchFeatureService)(l,{customParameters:s,apiKey:i}),c=J(e.layers,o.layers,t),d=J(e.tables,o.tables,t);e.layers=c.itemResources,e.tables=d.itemResources;const f=[...c.added,...d.added],p=u?[...u.layers,...u.tables]:[];return await M(e,f,l,p),e}function J(e,a,t){const n=(0,r.e5)(e,a,((e,a)=>e.id===a.id));e=e.filter((e=>!n.removed.some((a=>a.id===e.id))));const l=n.added.map((({id:e})=>({id:e})));return l.forEach((({id:a})=>{e.push({id:a})})),{itemResources:e,added:l.filter((({id:e})=>!t.includes(e)))}}async function M(e,a,t,r){const n=a.map((({id:e})=>new u["default"]({url:t,layerId:e,sourceJSON:r.find((({id:a})=>a===e))})));await(0,i.as)(n.map((e=>e.load()))),n.forEach((a=>{const{layerId:t,loaded:r,defaultPopupTemplate:n}=a;r&&!(0,s.Wi)(n)&&Z(a,{id:t,popupInfo:n.toJSON()},e)}))}function Z(e,a,t){e.isTable?D(t.tables,a):D(t.layers,a)}function D(e,a){const t=e.findIndex((({id:e})=>e===a.id));-1===t?e.push(a):e[t]=a}function K(e){const{portalItem:a}=e;return(0,d.y2)(e)&&!e.dynamicDataSource&&!!a?.loaded&&a.type===b}async function U(e){if(!e?.length)throw new n.Z("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");await Promise.all(e.map((e=>e.load())));for(const r of e)if(!K(r))throw new n.Z("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${S(r,"does not conform")}`,{layer:r});const a=e.map((e=>e.portalItem.id));if(new Set(a).size>1)throw new n.Z("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const t=e.map((e=>e.layerId));if(new Set(t).size!==t.length)throw new n.Z("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}function E(e,a){var t,r;let n=p["default"].from(a);return n.id&&(n=n.clone(),n.id=null),(t=n).type??(t.type=b),(r=n).portal??(r.portal=f.Z.getDefault()),I(e,n),n}async function x(e,a){const{url:t,layerId:r,title:n,fullExtent:l,isTable:i}=e,o=(0,c.Qc)(t),u=(0,s.pC)(o)&&"FeatureServer"===o.serverType;a.url=u?t:`${t}/${r}`,a.title||(a.title=n),a.extent=null,!i&&(0,s.pC)(l)&&(a.extent=await(0,w.$o)(l)),(0,w.ck)(a,w.Kz.METADATA),(0,w.ck)(a,w.Kz.MULTI_LAYER),(0,w.qj)(a,w.Kz.SINGLE_LAYER),i&&(0,w.qj)(a,w.Kz.TABLE),O(a)}async function A(e,a,t){const r=e.portal;await r._signIn(),await r.user.addItem({item:e,data:a,folder:t?.folder})}const k=(0,i.Ds)(R);async function R(e,a){await v(e),T(e);const t=e.portalItem,r=(0,m.Y)(t),n=await P(e,r,a),l=await N(t,[{layer:e,layerJSON:n}]);return O(t),await t.update({data:l}),(0,o.D)(r),t}const $=(0,i.Ds)((async(e,a)=>{await U(e);const t=e[0].portalItem,r=(0,m.Y)(t),n=await Promise.all(e.map((e=>P(e,r,a)))),l=await N(t,e.map(((e,a)=>({layer:e,layerJSON:n[a]}))));return O(t),await t.update({data:l}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),(0,o.D)(r),t.clone()})),V=(0,i.Ds)(z);async function z(e,a,t){await v(e);const r=E(e,a),n=(0,m.Y)(r),l=g({layer:e,layerJSON:await P(e,n,t)});return await x(e,r),await A(r,l,t),e.portalItem=r,(0,o.D)(n),r}},66361:function(e,a,t){t.r(a),t.d(a,{fetchFeatureService:function(){return h},fromUrl:function(){return u}});var r=t(66341),n=t(70375),l=t(61681),s=t(3466),i=t(20692),o=t(92557);async function u(e){const a=e.properties?.customParameters,r=await d(e.url,a),n={...e.properties,url:e.url};if(!r.sublayerIds)return null!=r.layerOrTableId&&(n.layerId=r.layerOrTableId,n.sourceJSON=r.sourceJSON),new r.Constructor(n);const l=new(0,(await t.e(6753).then(t.bind(t,56753))).default)({title:r.parsedUrl.title});return c(l,r,n),l}function y(e,a){return e?e.find((e=>e.id===a)):null}function c(e,a,t){function r(e,r){const n={...t,layerId:e,sublayerTitleMode:"service-name"};return(0,l.pC)(r)&&(n.sourceJSON=r),new a.Constructor(n)}a.sublayerIds.forEach((t=>{const n=r(t,y(a.sublayerInfos,t));e.add(n)})),a.tableIds.forEach((t=>{const n=r(t,y(a.tableInfos,t));e.tables.add(n)}))}async function d(e,a){let t=(0,i.Qc)(e);if((0,l.Wi)(t)&&(t=await f(e,a)),(0,l.Wi)(t))throw new n.Z("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:r,sublayer:s}=t;let o;const u={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(r){case"MapServer":o=null!=s?"FeatureLayer":S(e,a).then((e=>e?"TileLayer":"MapImageLayer"));break;case"ImageServer":o=I(e,{customParameters:a}).then((e=>{const a=e.tileInfo&&e.tileInfo.format;return e.tileInfo?"LERC"!==a?.toUpperCase()||e.cacheType&&"elevation"!==e.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"}));break;case"SceneServer":o=I(t.url.path,{customParameters:a}).then((e=>{if(e){if("Voxel"===e?.layerType)return"VoxelLayer";if(e?.layers&&Array.isArray(e.layers)&&e.layers.length>0){const a={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"},t=e.layers[0]?.layerType;if(null!=a[t])return a[t]}}return"SceneLayer"}));break;default:o=u[r]}const y={FeatureLayer:!0,SceneLayer:!0},c="FeatureServer"===r,d={parsedUrl:t,Constructor:null,layerOrTableId:c?s:null,sublayerIds:null,tableIds:null},p=await o;if(y[p]&&null==s){const t=await m(e,r,a);c&&(d.sublayerInfos=t.layerInfos,d.tableInfos=t.tableInfos),1!==t.layerIds.length+t.tableIds.length?(d.sublayerIds=t.layerIds,d.tableIds=t.tableIds):c&&(d.layerOrTableId=t.layerIds[0]??t.tableIds[0],d.sourceJSON=t.layerInfos[0]??t.tableInfos[0])}return d.Constructor=await b(p),d}async function f(e,a){const t=await I(e,{customParameters:a});let r=null,n=null;const o=t.type;if("Feature Layer"===o||"Table"===o?(r="FeatureServer",n=t.id):"indexedVector"===o?r="VectorTileServer":t.hasOwnProperty("mapName")?r="MapServer":t.hasOwnProperty("bandCount")&&t.hasOwnProperty("pixelSizeX")?r="ImageServer":t.hasOwnProperty("maxRecordCount")&&t.hasOwnProperty("allowGeometryUpdates")?r="FeatureServer":t.hasOwnProperty("streamUrls")?r="StreamServer":p(t)?(r="SceneServer",n=t.id):t.hasOwnProperty("layers")&&p(t.layers?.[0])&&(r="SceneServer"),!r)return null;const u=null!=n?(0,i.DR)(e):null;return{title:(0,l.pC)(u)&&t.name||(0,s.vt)(e),serverType:r,sublayer:n,url:{path:(0,l.pC)(u)?u.serviceUrl:(0,s.mN)(e).path}}}function p(e){return e?.hasOwnProperty("store")&&e.hasOwnProperty("id")&&"number"==typeof e.id}async function m(e,a,t){let r,n=!1;if("FeatureServer"===a){const a=await h(e,{customParameters:t});n=!!a.layersJSON,r=a.layersJSON||a.serviceJSON}else r=await I(e,{customParameters:t});const l=r?.layers,s=r?.tables;return{layerIds:l?.map((e=>e.id)).reverse()||[],tableIds:s?.map((e=>e.id)).reverse()||[],layerInfos:n?l:[],tableInfos:n?s:[]}}function w(e){return!e.type||"Feature Layer"===e.type}async function h(e,a){let t=await I(e,a);t=t||{},t.layers=t.layers?.filter(w)||[];const r={serviceJSON:t};if(t.currentVersion<10.5)return r;const n=await I(e+"/layers",a);return r.layersJSON={layers:n?.layers?.filter(w)||[],tables:n?.tables||[]},r}async function b(e){return(0,o.T[e])()}async function S(e,a){return(await I(e,{customParameters:a})).tileInfo}async function I(e,a){return(await(0,r["default"])(e,{responseType:"json",query:{f:"json",...a?.customParameters,token:a?.apiKey}})).data}},92557:function(e,a,t){t.d(a,{T:function(){return r}});const r={BingMapsLayer:async()=>(await t.e(5505).then(t.bind(t,5505))).default,BuildingSceneLayer:async()=>(await Promise.all([t.e(2192),t.e(2175)]).then(t.bind(t,22175))).default,CSVLayer:async()=>(await t.e(4730).then(t.bind(t,64730))).default,ElevationLayer:async()=>(await t.e(8509).then(t.bind(t,8509))).default,FeatureLayer:async()=>(await Promise.resolve().then(t.bind(t,60691))).default,GroupLayer:async()=>(await t.e(6753).then(t.bind(t,56753))).default,GeoRSSLayer:async()=>(await t.e(4417).then(t.bind(t,84417))).default,GeoJSONLayer:async()=>(await t.e(6330).then(t.bind(t,66330))).default,ImageryLayer:async()=>(await Promise.all([t.e(1329),t.e(7678),t.e(8927),t.e(245)]).then(t.bind(t,245))).default,ImageryTileLayer:async()=>(await Promise.all([t.e(1329),t.e(8299),t.e(7678),t.e(8927),t.e(7317)]).then(t.bind(t,17317))).default,IntegratedMeshLayer:async()=>(await Promise.all([t.e(2192),t.e(1288)]).then(t.bind(t,31288))).default,KMLLayer:async()=>(await t.e(3931).then(t.bind(t,83931))).default,LineOfSightLayer:async()=>(await t.e(2005).then(t.bind(t,22005))).default,MapImageLayer:async()=>(await Promise.all([t.e(7153),t.e(9420)]).then(t.bind(t,69420))).default,MapNotesLayer:async()=>(await t.e(410).then(t.bind(t,410))).default,OGCFeatureLayer:async()=>(await t.e(8888).then(t.bind(t,98888))).default,OpenStreetMapLayer:async()=>(await t.e(3206).then(t.bind(t,33206))).default,PointCloudLayer:async()=>(await t.e(4949).then(t.bind(t,74949))).default,RouteLayer:async()=>(await Promise.all([t.e(3970),t.e(2983)]).then(t.bind(t,32983))).default,SceneLayer:async()=>(await Promise.all([t.e(2192),t.e(6115)]).then(t.bind(t,16115))).default,StreamLayer:async()=>(await t.e(1604).then(t.bind(t,91604))).default,TileLayer:async()=>(await Promise.all([t.e(7153),t.e(5369)]).then(t.bind(t,75369))).default,UnknownLayer:async()=>(await t.e(81).then(t.bind(t,40081))).default,UnsupportedLayer:async()=>(await t.e(4864).then(t.bind(t,74864))).default,VectorTileLayer:async()=>(await Promise.all([t.e(3043),t.e(4043)]).then(t.bind(t,59136))).default,VoxelLayer:async()=>(await t.e(9478).then(t.bind(t,39478))).default,WebTileLayer:async()=>(await t.e(9859).then(t.bind(t,89859))).default,WFSLayer:async()=>(await t.e(751).then(t.bind(t,10751))).default,WMSLayer:async()=>(await t.e(5734).then(t.bind(t,75734))).default,WMTSLayer:async()=>(await t.e(6642).then(t.bind(t,56642))).default}},84513:function(e,a,t){t.d(a,{Y:function(){return s},h:function(){return l}});var r=t(3466),n=t(81577);function l(e){return{origin:"portal-item",url:(0,r.mN)(e.itemUrl),portal:e.portal||n.Z.getDefault(),portalItem:e,readResourcePaths:[]}}function s(e){return{origin:"portal-item",messages:[],writtenProperties:[],url:e.itemUrl?(0,r.mN)(e.itemUrl):null,portal:e.portal||n.Z.getDefault(),portalItem:e}}}}]);
//# sourceMappingURL=8015.72c93891.js.map